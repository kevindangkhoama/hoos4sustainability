{% extends 'hello/base.html' %}
{% block content %}
{% load static %}

<html>
	<head>
		<meta charset="UTF-8">
		<title>Record Journey</title>
	</head>
	<body>
  <h1>Insert Points.txt</h1>
  <input type="file" id="file-input">
  <button onclick="parseTotalPoints()">Upload</button>
  <p id="total-points"></p>
  <script>
    function parseTotalPoints() {
  // Get the selected file from the input element
  let fileInput = document.getElementById("file-input");
  let file = fileInput.files[0];
  // Create a file reader object
  let reader = new FileReader();
  // Set up the onload function to read the contents of the file
  reader.onload = function(event) {
    let contents = event.target.result;
    // Parse the contents of the file to extract the total points
    let totalPointsMatch = contents.match(/^total points = (\d+)$/i);
    if (totalPointsMatch) {
      let totalPoints = parseInt(totalPointsMatch[1]);
      // Store the total points in a variable and display it on the page
      let totalPointsElement = document.getElementById("total-points");
      totalPointsElement.textContent = "Total points: " + totalPoints;
    } else {
      let totalPointsElement = document.getElementById("total-points");
      totalPointsElement.textContent = "Invalid file format";
    }
  };
  // Read the file as text
  reader.readAsText(file);
}
  </script>
</body>
	<body style="text-align:center;">
		<h1>Record Journey</h1>
		<form>
			<label for="transportation">Select Transport:</label>
			<select id="transportation" name="transportation">
				<option value="" disabled selected>Select Transport</option>
				<option value="public">Metro, Bus, Train</option>
				<option value="active">Walking, Running, Biking</option>
				<option value="shared">Ridesharing, Carpooling, Hitchhiking</option>
			</select><br><br>

			<label for="point_a">Origin:</label>
			<input type="text" name="point_a" id="point_a"><br><br>

			<label for="point_b">Destination:</label>
			<input type="text" name="point_b" id="point_b"><br><br>

			<button type="button" onclick="calculatePoints()">Calculate Points</button>
		</form>
		
		<script>
			function calculatePoints() {
				var transportation = document.getElementById("transportation").value;
				var pointA = document.getElementById("point_a").value;
				var pointB = document.getElementById("point_b").value;

				if (transportation === "" || pointA === "" || pointB === "") {
					alert("Please fill in all fields before calculating points.");
					return;
				}
				
				

				var service = new google.maps.DistanceMatrixService();
				service.getDistanceMatrix({
					origins: [pointA],
					destinations: [pointB],
					travelMode: google.maps.TravelMode.DRIVING,
					unitSystem: google.maps.UnitSystem.IMPERIAL,
					avoidHighways: false,
					avoidTolls: false
				}, function(response, status) {
					if (status == google.maps.DistanceMatrixStatus.OK && response.rows[0].elements[0].status != "ZERO_RESULTS") {
						var distance = response.rows[0].elements[0].distance.text;
						var points = 0;
						switch (transportation) {
							case "active":
								points = parseFloat(distance) * 10;
								break;
							case "public":
								points = parseFloat(distance) * 5;
								break;
							case "shared":
								points = parseFloat(distance) * 2;
								break;
						}
						document.getElementById("pointcalc").innerHTML = points;
						document.getElementById("distance").innerHTML = distance;
					} else {
						alert("Unable to find the distance between the two locations.");
						document.getElementById("pointcalc").innerHTML = "";
						document.getElementById("distance").innerHTML = "";
					}
					let totalPoints = parseInt(document.getElementById("total-points").textContent.match(/\d+/)[0]);
                    let pointcalc = parseFloat(document.getElementById("pointcalc").textContent);
                    let newtotal = totalPoints + pointcalc;
                    document.getElementById("newtotal").textContent = newtotal;
                    // create a string with the new total value
                    var newTotalString = "New Total: " + newtotal;

                    // write the new total string to the file
                    file.write(newTotalString);

				});
			}
		</script>
		
		<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB039a5JHinvotsgxrUB0_9Vs0GnbC8ttk&libraries=places"></script>
		
		<p style="text-align:center;">Points Earned: <span id="pointcalc"></span></p>
		<p style="text-align:center;">Distance: <span id="distance"></p>
		<p style="text-align:center;">New Total: <span id="newtotal"></p>
		<p style="text-align:left;"><u>Multipliers:</u> <br>Metro, Bus, Train: 5x <br> Walking, Running, Biking: 10x <br>
		    Ridesharing, Carpooling, Hitchhiking: 2x
		</p>
		
	
	</body>
</html>

{%endblock%}
